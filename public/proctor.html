<html>

<head>

</head>

<body>

    <div id="videos"></div>















    <!-- scripts! -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" integrity="sha384-9aIt2nRpC12Uk9gS9baDl411NQApFmC26EwAOH8WgZl5MYYxFfc+NcPb1dKGj7Sk" crossorigin="anonymous">

    <!-- JS, Popper.js, and jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" integrity="sha384-OgVRvuATP1z7JjHLkuOU7Xw704+h835Lr+6QL9UvYjZE3Ipu6Tp75j7Bh/kR0JKI" crossorigin="anonymous"></script>

    <script src="https://webrtc.github.io/adapter/adapter-latest.js"></script>
    <script src="face-api.min.js"></script>
    <script>
        faceapi.loadFaceRecognitionModel()



        async function loadCams() {

            for (let i = 6; i < students.length + 1; i = i + 2) {
                var success = true;
                try {
                    image = getImg(i);
                } catch {
                    console.log(i + "doesn't work")
                    success = false
                }
                if (success) {
                    try {
                        var distance = faceapi.utils.round(
                            faceapi.euclideanDistance(await faceapi.computeFaceDescriptor(await getImg(i)), await faceapi.computeFaceDescriptor(students[i].pic))
                        )
                        console.log(distance);
                        students[i].confidence = distance;
                    } catch (e) {
                        console.log(e)
                    }


                    students[i].pic = getImg(i).cloneNode(true);
                }

            }
        }



        function getImg(num) {
            return snapshot(document.getElementById(num));
        }

        function snapshot(video) {
            can = document.createElement("canvas");
            imager = document.createElement("img");
            context = can.getContext("2d");
            context.drawImage(video, 0, 0, can.width, can.height);
            var data = can.toDataURL('image/png');
            imager.setAttribute('src', data);
            return imager;
        }





        var videos = document.getElementById("videos")
        var students = [student()];

        function student() {
            var a = {}
            a.connection = new RTCPeerConnection({
                iceServers: [{
                    urls: "stun:stun.1.google.com:19302"
                }]
            })
            a.connection.onaddstream = function(student) {
                var video = document.createElement("video");
                video.srcObject = student.stream;
                video.play();
                video.classList.add('stream');
                video.setAttribute("id", students.length);
                videos.appendChild(video);
            }

            a.lastImg;

            return a;
        }
        var room;
        room = 0;

        function createRoom(sconnection) {

            sconnection.createOffer({
                offerToReceiveVideo: true,
                offerToReceiveAudio: true
            }).then(function(hostdesc) {
                sconnection.setLocalDescription(hostdesc)
            })
            sconnection.onicecandidate = function() {

                $.post("/ss/createroom", {
                    room: room,
                    key: sconnection.localDescription.sdp
                }, function(data) {

                })
            }
        }

        students[0] = student();

        createRoom(students[0].connection);

        setTimeout(startref, 1000);







        //


        function startref() {
            setInterval(function() {


                $.post("/ss/reloadroom", {
                    room: room,
                }, function(users) {
                    if (users) {
                        console.log(users)
                        users.forEach(

                            function(user) {

                                students[students.length - 1].connection.setRemoteDescription(new RTCSessionDescription({
                                    type: "answer",
                                    sdp: user
                                }));


                                var newStudent = student();

                                students.push(newStudent);
                                createRoom(newStudent.connection);
                            });
                    }

                });

                loadCams();
            }, 1000)

        }
    </script>
</body>




</html>